---
title: "PSPG Bootcamp 2020: Data Manipulation and Plotting in R"
author: "Jackie Ernest and Vincent Chang"
date: "8/12/2020"
output: html_document
---

Objectives:
1) Learn the basics of dplyr
    -Selecting, Filtering, and Arranging
    -Making a series of function with pipes %>%
    -Mutate new and existing columns
    -Wide and long tables
2) Learn the basics of ggplot2
    -Setting up your dataframe for easy plotting
    -Plot lines, scatter plots, boxplots
    -Compare different subpopulations
    
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Installing and Loading packages
```{r}
#Comment out if you've already installed them
install.packages("dplyr")
install.packages("tidyr")
install.packages("ggplot2")

#Load libraries
library(dplyr)
library(tidyr)
library(ggplot2)
```




Loading your dataset
```{r}
setwd("YOUR/PATH/HERE")
PKdata <- read.csv("simulation_df.csv")
simtab <- read_nm_table("~/Documents/Courses/Bootcamp/bootcamp_2020/nm/sdtab01")
#Let's take a glimpse at your dataset
head(PKdata)
#Alternatively, click on PKdata in your Global Environment toolbar on the right
```

Dplyr Cheatsheet
https://raw.githubusercontent.com/rstudio/cheatsheets/master/data-transformation.pdf

Selecting
```{r}
#You can select specific columns using select()
#Let's de-identify our dataset by removing personally identifiable columns
deidentified <- select(PKdata, ID, TIME, DV, DOSE, BW, SEX, HIV)

#You can also do this by "subtracting" the columns you don't want with -
deidentified <- select(PKdata, _________________________)

#You can also search through your columns with helpers: contains(), starts_with(), ends_with()
What_did_this_do <- select(PKdata, ends_with("V"))
#Write your answer commented out below:


#Can you use helpers to create the same deidentified dataset?



```

Filtering
```{r}
#You can filter out specific rows using filter()
#For example, selecting all patients who received a specific dose
Dosed_600 <- filter(PKdata, DOSE == 600)

#You can use any logical function in R to designate your filter criteria
# > greater than, <= greater equal than
# < less than, <= lesser equal than
# ! not
# & and
# | or
#Can you filter for patients with body weight greater or equal than 45kg?


#You can also use & or | to create more complex logical functions
#Let's filter for patients that received a dose greater than or equal to 600 and HIV+
Dosed600up_HIV <- filter(PKdata, _________ & _________)

#Challenge: Filter for patients who received the lowest or highest dose, and is female with HIV or male
#Remember there are always many ways to code something :)



```

Arranging
```{r}
#arrange() will reorder rows or columns according to your specifications (default from low to high)
#For example in PK data we will often organize our rows by patient ID, then by time.
PKdata <- arrange(__________)
```

Putting it all together with Pipes %>%
```{r}
#Pipes are used to connect the output of one function to the input of another
#Let's deidentify our dataset, filter for 600mg dose, and arrange by id and time all together
PKdata1 <- PKdata %>%
  select(_________) %>%
  filter(_________) %>%
  arrange(_________)

#Try this one for yourself!
#Let's rename DV into CONC, remove the DV column, filter for HIV+ or body weight less than 45kg, then...
#we want to see the trough levels of each patient (defined as the 24hr timepoint)




```

Mutate
```{r}
#mutate() can create new columns or alter existing ones
#For example, BMI is often calculated from HT and WT
#BMI = weight(kg)/height(m)^2

PKdata1 <- PKdata1 %>%
  mutate(BMI = BW/HT^2) #are the units correct? check the data dictionary!

#Now you try converting DV from mg/L into micromoles!
#The drug used here is remdesivir




```

Our first Plot!!
ggplot2 cheatsheet: https://raw.githubusercontent.com/rstudio/cheatsheets/master/data-visualization-2.1.pdf
```{r}
ggplot(DATA_GOES_HERE) + 
  geom_point(aes(x=____, y=_____)) + ##What are we trying to plot with a PK profile?
  geom_line(aes(x=____,y=_____,group=factor(ID)),alpha = 0.1, linetype=2,size=0.1)
```

Graphing Subpopulations
```{r}
ggplot(simtab) + 
  geom_point(aes(x=TIME, y=DV, color = as.factor(DOSE))) + ##What are we trying to plot with a PK profile?
  geom_line(aes(x=TIME, y=DV, group=factor(ID), color = as.factor(DOSE)),alpha = 0.1, linetype=2,size=0.1)
```

Another way to stratify
```{r}
#It's still a little too cluttered
ggplot(simtab) + 
  geom_point(aes(x=TIME, y=DV, color = as.factor(DOSE))) + ##What are we trying to plot with a PK profile?
  geom_line(aes(x=TIME, y=DV, group=factor(ID), color = as.factor(DOSE)),alpha = 0.1, linetype=2,size=0.1) +
  facet_wrap(.~DOSE)
```

Let's try some on your own
```{r}
#Copy and paste from above, and let's plot stratified by HIV status




#Now let's try adding 2 stratifications: color by HIV and facet_wrap by SEX. Then try the other way around!




#Challenge: Plot stratified by body weight, one color for above 45kg and another color for below. Make sure to have a legend :)




```

